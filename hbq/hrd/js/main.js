/*
 * Author: bindy Yuan
 * Version: 0.1.0
 * Compile Date: 2016-09-13 11:06
*/ 
function orientationChange(){90==window.orientation||-90==window.orientation?$("#originTip").removeClass("hide"):$("#originTip").addClass("hide")}function rect(){}window.addEventListener("onorientationchange"in window?"orientationchange":"resize",orientationChange,!1),orientationChange();var hrd=function(){var e,t,a,o,n,r,i,s=function(){var t=new createjs.LoadQueue(!1);t.on("complete",function(){$("#load").addClass("ani");var t=new createjs.LoadQueue(!1);t.on("complete",function(){$("#load").addClass("hide").removeClass("ani"),$("#main").removeClass("hide"),e=new Swiper("#main",{direction:"vertical",onTouchStart:g,onInit:g,initialSlide:0,onTransitionEnd:function(e){switch(e.activeIndex){case 1:d();break;case 2:e.removeSlide([0,1]),h()}}}),$("#story01,#story02").one("touchend",function(){$(this).addClass("speed")}),$("#story01").on("webkitAnimationEnd animationend",".end-animation",function(){$("#story01").on("touchend",function(){u(e,1)})}),$("#story02").on("webkitAnimationEnd animationend",".end-animation",function(){$("#startBtn").on("touchend",function(){u(e,2),n.pause()})}),$("#video").on("touchend",".close-btn",z),f(),p()}),t.on("error",c),t.loadManifest(config.preload)}),t.on("error",c),t.loadManifest([config.imgPath+"load.png"])},c=function(){console.log("资源加载出错")},d=function(){i=new createjs.LoadQueue(!1);var e=new Array;for(var t in config.rect)e.push({id:t,src:config.imgPath+config.rect[t].view});i.loadManifest(e),rect.prototype.preload=i},l=function(e){e&&e.stop()},p=function(){n=new Audio(config.audioPath+"begin.mp3"),n.play(),n.loop=!0,wx.config({debug:!1,appId:"",timestamp:1,nonceStr:"",signature:"",jsApiList:[]}),wx.ready(function(){n.play()})},f=function(){var e=new createjs.LoadQueue(!0);e.installPlugin(createjs.Sound),e.loadManifest([{id:"rect",src:config.audioPath+"rect.mp3"},{id:"pass",src:config.audioPath+"pass.mp3"}])},u=function(e,t){e&&t&&(v(e),e.slideTo(t))},v=function(e){e.unlockSwipes()},g=function(e){e.lockSwipes()},h=function(){if(w(),S(),o)for(var e=0;e<o.length;e++)o[e].rectItem.removeAllEventListeners(),o[e]=null;a.removeAllChildren();var t=a.data.curLevel;t=0!=t?t:config.level.length,$("#gameMain").removeClass("level-0"+t+" show-pop").addClass("level-0"+(a.data.curLevel+1)),a.data.step=0;for(var n=config.level[a.data.curLevel],r=new Array,e=0;e<n.length;e++)for(var s=n[e],c=0;c<s.length;c++)"0"!=s[c]&&s[c]&&(i.getResult(s[c])||r.push({id:s[c],src:config.imgPath+config.rect[s[c]].view}));r.length>0?(i.on("complete",m),i.loadManifest(r)):m(),a.data.$step.html("000"),a.data.passLevel<=a.data.curLevel||a.data.curLevel>=config.level.length-1?$("#gameMain .next-btn").addClass("hide"):$("#gameMain .next-btn").removeClass("hide")},m=function(){o=new Array;for(var e=config.level[a.data.curLevel],t=0;t<e.length;t++)for(var n=e[t],r=0;r<n.length;r++)if("0"==n[r]&&(a.data.pos[t]||(a.data.pos[t]=new Array),a.data.pos[t][r]=0),n[r]){var i=new rect;i.init(n[r],t,r),o.push(i)}},w=function(){if(!t){var e=$("#gameViewBox"),o=e.width(),n=e.height(),i=document.getElementById("gameView");i.width=o,i.height=n,t=new createjs.Stage("gameView"),createjs.Ticker.addEventListener("tick",M),createjs.Touch.enable(t),a=new createjs.Container,t.addChild(a),a.data={};var s=window.localStorage,c=s.getItem("passLevel");c?a.data.passLevel=parseInt(c):(s.setItem("passLevel",0),a.data.passLevel=0),a.data.curLevel=0,a.data.pos=new Array,a.data.$step=$("#step"),a.data.step=0,rect.prototype.data||(rect.prototype.data={perSize:o/4,perDir:.005*o,moveDir:o/4/50}),rect.prototype.rectContainer=a,r=window.localStorage.getItem("isShare"),$("#result").on("touchend",".continue-btn",y).on("touchend",".look-btn",function(){L()}).on("touchend",".again-btn",function(){a.data.curLevel=0,h()}),$("#share").on("touchend",function(){C()}),$("#gameMain").on("touchend",".reset-btn",function(){h()}).on("touchend",".next-btn",function(){a.data.passLevel>a.data.curLevel&&(a.data.curLevel++,h())}).on("touchend",".tips",function(){$(this).addClass("tips-hide").on("transitionend webkitTransitionEnd",function(){$(this).addClass("hide")})})}},y=function(){a.data.curLevel++,h()},S=function(){$("#result").removeClass("show all-pass")},C=function(){$("#share").removeClass("show all-pass")},L=function(){$("#video").addClass("show"),$("#result").removeClass("show"),l(rect.prototype.rectSound)},z=function(){$("#result").addClass("show"),$("#video").removeClass("show").find("video")[0].pause()},M=function(){t.update()};return{init:s}}();rect.prototype={init:function(e,t,a){self=this;var o=rect.prototype.rectContainer;self.rectItem=new createjs.Container;{var n=config.rect[e],r=this.data.perSize*a+this.data.perDir,i=this.data.perSize*t+this.data.perDir;this.data.perSize*n.size[0]-2*this.data.perDir,this.data.perSize*n.size[1]-2*this.data.perDir}self.rectItem.x=r,self.rectItem.y=i,self.rectItem.data={},self.rectItem.data.type=e,self.rectItem.data.pos=[t,a];for(var s=0;s<n.size[1];s++)for(var c=0;c<n.size[0];c++)o.data.pos[t+s]||(o.data.pos[t+s]=new Array),o.data.pos[t+s][a+c]=e!=config.master?1:2;var d,l=rect.prototype.preload.getResult(e);d=new createjs.Bitmap(l?l:config.imgPath+n.view),self.rectItem.addEventListener("pressmove",function(e){e.currentTarget.pressMoveX||(e.currentTarget.pressMoveX=e.stageX),e.currentTarget.pressMoveY||(e.currentTarget.pressMoveY=e.stageY)}),self.rectItem.addEventListener("pressup",function(e){var t=-1,a=e.currentTarget,o=e.stageX-a.pressMoveX,n=e.stageY-a.pressMoveY;Math.abs(o)>Math.abs(n)&&Math.abs(o)>rect.prototype.data.moveDir?t=0>o?config.dir.LEFT:config.dir.RIGHT:Math.abs(n)>rect.prototype.data.moveDir&&(t=0>n?config.dir.UP:config.dir.DOWN),self.move(t,a),a.pressMoveX=0,a.pressMoveY=0}),o.addChild(self.rectItem),self.rectItem.addChild(d)},move:function(e,t){var a=config.rect[t.data.type],o=t.data.pos,n=rect.prototype.rectContainer.data.pos;if(!t.data.isMove){t.data.curDir=e;var r;switch(e){case config.dir.UP:for(var i=0;i<a.size[0];i++)if(o[0]-1<0||0!=n[o[0]-1][o[1]+i])return;for(createjs.Tween.get(t).to({y:t.y+-1*rect.prototype.data.perSize},config.rectMoveTime).call(self.moveEnd),r=[o[0]-1,o[1]],i=0;i<a.size[0];i++)n[o[0]-1][o[1]+i]=1;break;case config.dir.DOWN:for(var i=0;i<a.size[0];i++)if(o[0]+a.size[1]>=n.length||0!=n[o[0]+a.size[1]][o[1]+i])return;for(createjs.Tween.get(t).to({y:t.y+rect.prototype.data.perSize},config.rectMoveTime).call(self.moveEnd),r=[o[0]+1,o[1]],i=0;i<a.size[0];i++)n[o[0]+a.size[1]][o[1]+i]=1;break;case config.dir.LEFT:for(var i=0;i<a.size[1];i++)if(o[1]-1<0||0!=n[o[0]+i][o[1]-1])return;for(createjs.Tween.get(t).to({x:t.x+-1*rect.prototype.data.perSize},config.rectMoveTime).call(self.moveEnd),r=[o[0],o[1]-1],i=0;i<a.size[1];i++)n[o[0]+i][o[1]-1]=1;break;case config.dir.RIGHT:for(var i=0;i<a.size[1];i++)if(0!=n[o[0]+i][o[1]+a.size[0]])return;for(createjs.Tween.get(t).to({x:t.x+rect.prototype.data.perSize},config.rectMoveTime).call(self.moveEnd),r=[o[0],o[1]+1],i=0;i<a.size[1];i++)n[o[0]+i][o[1]+a.size[0]]=1}r&&(t.data.pos=r,t.data.isMove=!0,self.stepUpdate(),self.playRectSound(),t.data.type==config.master&&r[0]==config.winPos[0]&&r[1]==config.winPos[1]&&setTimeout(self.win,500))}},playRectSound:function(){rect.prototype.rectSound?rect.prototype.rectSound.play("rect",{loop:0}):rect.prototype.rectSound=createjs.Sound.play("rect",{loop:0})},playPassSound:function(){rect.prototype.passSound?rect.prototype.passSound.play("pass",{loop:0}):rect.prototype.passSound=createjs.Sound.play("pass",{loop:0})},win:function(){var e=rect.prototype.rectContainer;e.data.passLevel=e.data.passLevel>e.data.curLevel?e.data.passLevel:e.data.curLevel+1,window.localStorage.setItem("passLevel",e.data.passLevel),self.resultStar(),e.data.curLevel>=config.level.length-1?$("#result").addClass("show all-pass"):$("#result").addClass("show").removeClass("all-pass"),$("#gameMain").addClass("show-pop"),self.playPassSound()},resultStar:function(){for(var e=rect.prototype.rectContainer,t=e.data.step,a=config.score[e.data.curLevel],o=0;o<a.length&&!(t<=a[o]);o++);var n="",r=parseInt(config.scoreStar[o]/1),i=Math.ceil(config.scoreStar[o]%1);for(o=0;3>o;o++)r>0?(n+='<i class="all"><span></span></i>',r--):i>0?(n+='<i class="half"><span></span></i>',i--):n+="<i></i>";$("#star").html(n)},stepUpdate:function(){var e=rect.prototype.rectContainer,t=e.data.$step;if(t){e.data.step++;var a="000"+e.data.step.toString();t.html(a.substr(a.length-3))}},moveEnd:function(){var e=this;this.data.isMove=!1;var t=config.rect[e.data.type],a=e.data.pos,o=rect.prototype.rectContainer.data.pos,n=this.data.curDir;switch(n){case config.dir.UP:for(i=0;i<t.size[0];i++)o[a[0]+t.size[1]][a[1]+i]=0;break;case config.dir.DOWN:for(i=0;i<t.size[0];i++)o[a[0]-1][a[1]+i]=0;break;case config.dir.LEFT:for(i=0;i<t.size[1];i++)o[a[0]+i][a[1]+t.size[0]]=0;break;case config.dir.RIGHT:for(i=0;i<t.size[1];i++)o[a[0]+i][a[1]-1]=0}}},hrd.init();